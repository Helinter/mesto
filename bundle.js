(()=>{"use strict";class e{constructor(e,t,s,n,i,o){this.id=e._id,this.myId=i,this.api=o,this._cardElement=t.querySelector(".element").cloneNode(!0),this._name=e.name,this._link=e.link,this._likes=e.likes,this._ownerId=e.ownerId,this._titleImage=this._cardElement.querySelector(".element__image"),this._deleteButton=this._cardElement.querySelector(".element__delete-button"),this._likeButton=this._cardElement.querySelector(".element__like-button"),this._likeCounter=this._cardElement.querySelector(".element__like-counter"),this._listItem=this._deleteButton.closest(".element"),this._handleCardClick=s,this._handleDeleteClick=n,this._imageData={link:this._link,name:this._name}}createCard(){return this._htmlSettings(),this._setEventListeners(),this._ownerId!==this.myId&&this._deleteButton.remove(),this.isLikedByCurrentUser()?this._likeButton.classList.add("element__like-button_active"):this._likeButton.classList.remove("element__like-button_active"),this._cardElement}_updateDeleteButton(){this._ownerId===this.myId?this._cardElement.appendChild(this._deleteButton):this._deleteButton.remove()}_htmlSettings(){this._cardElement.querySelector(".element__title").textContent=this._name,this._titleImage.setAttribute("src",this._link),this._titleImage.setAttribute("alt",this._name),this._likeCounter.textContent=this._likes.length}_setEventListeners(){this._likeButton.addEventListener("click",(()=>this.toggleLike())),this._deleteButton.addEventListener("click",(()=>this._deleteOn())),this._titleImage.addEventListener("click",(()=>this._popupImgOn()))}_popupImgOn(){this._handleCardClick(this._imageData)}_deleteOn(){this._handleDeleteClick(this)}deleteCard(){this.api.deleteCard(this.id).then((()=>{this._listItem.remove(),this._listItem=null,console.log("карточка удалена")})).catch((e=>{console.error("Ошибка при удалении карточки:",e)}))}updateLikeCount(){this._likeCounter.textContent=this._likes.length}isLikedByCurrentUser(){return this._likes.some((e=>e._id===this.myId))}toggleLike(){this.isLikedByCurrentUser()?this.api.deleteLike(this.id).then((e=>{this._likes=e.likes,this.updateLikeCount(),this._likeButton.classList.remove("element__like-button_active")})).catch((e=>{console.error("Ошибка при снятии лайка:",e)})):this.api.addLike(this.id).then((e=>{this._likes=e.likes,this.updateLikeCount(),this._likeButton.classList.add("element__like-button_active")})).catch((e=>{console.error("Ошибка при постановке лайка:",e)}))}}class t{constructor(e,t){this._submitButton=document.getElementById("cardSubmit"),this._config=e,this._formElement=t,this._inputsList=this._formElement.querySelectorAll(this._config.inputSelector),this._submitButtonElement=this._formElement.querySelector(this._config.submitButtonSelector),this._inputList=Array.from(this._formElement.querySelectorAll(this._config.inputSelector))}enableValidation(){this._setEventListeners()}_setEventListeners(){[...this._inputsList].forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState()}))}))}_toggleButtonState(){this._formElement.checkValidity()?(this._submitButtonElement.disabled=!1,this._submitButtonElement.classList.remove(this._config.inactiveButtonClass)):(this._submitButtonElement.disabled=!0,this._submitButtonElement.classList.add(this._config.inactiveButtonClass))}_checkInputValidity(e){this._errorElement=this._formElement.querySelector(`#${e.name}-error`);const t=e.validity.valid;this._errorElement&&(t?this._hideError(e):this._showError(e))}_showError(e){e.classList.add(this._config.inputErrorClass),this._errorElement.textContent=e.validationMessage}_hideError(e){e.classList.remove(this._config.inputErrorClass),this._errorElement.textContent=e.validationMessage}_buttonDisabled(){this._submitButton.classList.add(this._config.inactiveButtonClass),this._submitButton.disabled=!0}}const s={formSelector:".form",inputSelector:".popup__input",submitButtonSelector:".popup__container-button",inactiveButtonClass:"popup__container-button_invalid",inputErrorClass:"popup__input_invalid",errorClass:"error"};class n{constructor({items:e,renderer:t},s){this._renderer=t,this._container=document.querySelector(s),this._items=e.reverse()}renderItems(){this._items.forEach((e=>{this._renderer(e)}))}addItem(e,t=!1){t?this._container.prepend(e):this._container.append(e)}}class i{constructor(e){this._popupSelector=e,this._popupElement=document.querySelector(e),this._closePopup=this._popupElement.querySelector(".popup__container-close-button"),this._popupContainer=this._popupElement.querySelector(".popup__container"),this._handleEscClose=this._handleEscClose.bind(this)}open(){this._popupElement.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popupElement.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose(e){"Escape"===e.key&&this.close()}_handleOverlayClose(){this._popupElement.addEventListener("click",(e=>{e.target===this._popupElement&&this.close()}))}setEventListeners(){this._closePopup.addEventListener("click",this.close.bind(this)),this._handleOverlayClose()}}class o extends i{constructor(e){super(e),this._popupImg=this._popupElement.querySelector(".popup__img"),this._popupTitle=this._popupElement.querySelector(".popup__image-container-title")}open(e){super.open(),this._popupTitle.textContent=e.name,this._popupImg.src=e.link,this._popupImg.alt=e.name}}class r extends i{constructor(e,t){super(e),this.formElement=this._popupElement.querySelector(".form"),this.handleFormSubmit=t,this._formSubmitButton=this._popupElement.querySelector(".popup__container-button"),this._inputElements=this.formElement.querySelectorAll("input")}close(){super.close(),this.formElement.reset()}_getInputValues(){const e={};return this._inputElements.forEach((t=>{const s=t.name,n=t.value;e[s]=n})),e}setEventListeners(){super.setEventListeners(),this.formElement.addEventListener("submit",(e=>{e.preventDefault(),this.handleFormSubmit(this._getInputValues())}))}}class l{constructor({nameSelector:e,infoSelector:t}){this._nameElement=document.querySelector(e),this._infoElement=document.querySelector(t)}getUserInfo(){return{name:this._nameElement.textContent,info:this._infoElement.textContent}}setUserInfo({name:e,info:t}){this._nameElement.textContent=e,this._infoElement.textContent=t}}const a=new class{constructor(e){this.url=e.url,this.headers=e.headers}async getCards(){const e=await fetch(`${this.url}/cards`,{headers:this.headers});return e.ok?e.json():await Promise.reject(`Ошибка: ${e.status}`)}async addCard(e,t){const s=await fetch(`${this.url}/cards`,{method:"POST",headers:this.headers,body:JSON.stringify({name:e,link:t})});return s.ok?s.json():await Promise.reject(`Ошибка: ${s.status}`)}async updateProfile(e,t){const s=await fetch(`${this.url}/users/me`,{method:"PATCH",headers:this.headers,body:JSON.stringify({name:e,about:t})});return s.ok?s.json():await Promise.reject(`Ошибка: ${s.status}`)}async getUserInfo(){const e=await fetch(`${this.url}/users/me`,{headers:this.headers});return e.ok?e.json():await Promise.reject(`Ошибка: ${e.status}`)}async deleteCard(e){const t=await fetch(`${this.url}/cards/${e}`,{method:"DELETE",headers:this.headers});return t.ok?t.json():await Promise.reject(`Ошибка: ${t.status}`)}async addLike(e){const t=await fetch(`${this.url}/cards/likes/${e}`,{method:"PUT",headers:this.headers});return t.ok?t.json():await Promise.reject(`Ошибка: ${t.status}`)}async deleteLike(e){const t=await fetch(`${this.url}/cards/likes/${e}`,{method:"DELETE",headers:this.headers});return t.ok?t.json():await Promise.reject(`Ошибка: ${t.status}`)}async updateAvatar(e){const t=await fetch(`${this.url}/users/me/avatar`,{method:"PATCH",headers:this.headers,body:JSON.stringify({avatar:e})});return t.ok?t.json():await Promise.reject(`Ошибка: ${t.status}`)}}({url:"https://mesto.nomoreparties.co/v1/cohort-70",headers:{authorization:"9e4f7ba1-e97e-4ac3-9791-bede623fb8bb","Content-Type":"application/json"}}),c=document.querySelector(".card").content,u=document.querySelector(".popup__input_type_name"),h=document.querySelector(".popup__input_type_job"),d=document.querySelector(".profile__info-title"),_=document.querySelector(".profile__info-subtitle"),m=document.querySelector(".profile__avatar"),p=document.querySelector(".profile__info-edit-button"),E=document.forms.profileForm,f=document.querySelector(".profile__add-button"),k=document.forms.placeForm;let y;a.getUserInfo().then((e=>{const t=e;return d.textContent=t.name,_.textContent=t.about,m.src=t.avatar,y=t._id,y})).then((i=>{console.log(i);const d=new r(".popup_type_edit-profile",(e=>{const t=e.formName,s=e.formJob;a.updateProfile(t,s),v.setUserInfo({name:t,info:s}),d.close()}));function _(e){const n=new t(s,e);n.enableValidation(),e.addEventListener("submit",(()=>{n._buttonDisabled()}))}d.setEventListeners(),p.addEventListener("click",(()=>{const e=v.getUserInfo().name,t=v.getUserInfo().info;u.value=e,h.value=t,d.open()})),f.addEventListener("click",(()=>{m.open()}));const m=new r(".popup_type_card",(e=>{const t={name:e.formPlace,link:e.formLink,likes:[]};a.addCard(t.name,t.link).then((e=>{console.log(t),console.log("newCard._id",e._id),t._id=e._id,t.ownerId=i,function(e,t){const s=q(e,t);C.addItem(s,!0)}(t,i),m.close(),console.log(t)})).catch((e=>{console.error("Ошибка при добавлении карточки:",e)}))}));m.setEventListeners();const y=new o(".popup_type_image");y.setEventListeners();const v=new l({nameSelector:".profile__info-title",infoSelector:".profile__info-subtitle"});let C;function g(e){y.open(e)}_(E),_(k),a.getCards().then((e=>{const t=e.map((e=>({name:e.name,link:e.link,likes:e.likes,ownerId:e.owner._id,_id:e._id})));C=new n({items:t,renderer:$},".elements"),C.renderItems()}));const b=new r(".popup_type_delete",(function(){L.deleteCard(),b.close()}));let L;function S(e){b.open(),L=e}b.setEventListeners();const I=document.querySelector(".profile__avatar"),w=document.querySelector(".profile__avatar-edit-icon");document.forms.avatarForm,w.addEventListener("click",(function(){B.open()}));const B=new r(".popup_type_edit-avatar",(e=>{const t=e.formAvatar;a.updateAvatar(t).then((e=>{I.src=t,B.close()})).catch((e=>{console.error("Ошибка при обновлении аватара:",e)}))}));function q(t,s){return new e(t,c,g,S,s,a).createCard()}function $(e){C.addItem(q(e,i),!0)}B.setEventListeners()}))})();